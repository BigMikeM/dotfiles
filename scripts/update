#!/bin/bash
# -*- mode: sh -*-

# Get System Updates, Update NodeJS/NPM, Update Rust/Rustup, etc...
# Source: https://github.com/sapegin/dotfiles/blob/master/setup/update.sh
# Enhanced with better error handling, CLI options, and progress tracking

# Configuration
SKIP_SYSTEM=false
SKIP_NODE=false
SKIP_RUST=false
DRY_RUN=false
VERBOSE=false
CREATE_BACKUP=false

# Progress tracking
declare -a COMPLETED_TASKS=()
declare -a FAILED_TASKS=()

# Set directory
export DOTFILES="$HOME/.dotfiles"
SCRIPT_DIR="${DOTFILES}/scripts"

# Error handling
on_error() {
    local exit_code=$?
    error "Script failed with exit code: $exit_code"
    error "Last command: $BASH_COMMAND"
    show_summary
    exit "$exit_code"
}

set -euo pipefail
trap on_error ERR SIGTERM SIGINT

source "${SCRIPT_DIR}/utils"
source "${SCRIPT_DIR}/package_list"

usage() {
    cat <<EOF
Usage: $0 [OPTIONS]

OPTIONS:
    -h, --help          Show this help message
    -s, --skip-system   Skip system package updates
    -n, --skip-node     Skip Node.js updates
    -r, --skip-rust     Skip Rust updates
    -d, --dry-run       Show what would be updated without executing
    -v, --verbose       Enable verbose output
    -b, --backup        Create backup before updating
    --dotfiles-path     Specify dotfiles path (default: $HOME/.dotfiles)

Examples:
    $0                  # Update everything
    $0 --skip-system    # Skip system updates
    $0 --dry-run        # Show what would be updated
    $0 -v --backup      # Verbose mode with backup
EOF
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
    -h | --help)
        usage
        exit 0
        ;;
    -s | --skip-system)
        SKIP_SYSTEM=true
        shift
        ;;
    -n | --skip-node)
        SKIP_NODE=true
        shift
        ;;
    -r | --skip-rust)
        SKIP_RUST=true
        shift
        ;;
    -d | --dry-run)
        DRY_RUN=true
        shift
        ;;
    -v | --verbose)
        VERBOSE=true
        shift
        ;;
    -b | --backup)
        CREATE_BACKUP=true
        shift
        ;;
    --dotfiles-path)
        DOTFILES="$2"
        SCRIPT_DIR="${DOTFILES}/scripts"
        shift 2
        ;;
    *)
        error "Unknown option: $1"
        usage
        exit 1
        ;;
    esac
done

run_command() {
    local cmd="$*"
    if [[ "$VERBOSE" == true ]]; then
        info "Running: $cmd"
    fi

    if [[ "$DRY_RUN" == true ]]; then
        info "[DRY RUN] Would execute: $cmd"
        return 0
    fi

    eval "$cmd"
}

track_task() {
    local task_name="$1"
    local task_function="$2"

    info "Starting: $task_name"

    if "$task_function"; then
        COMPLETED_TASKS+=("$task_name")
        success "✓ $task_name completed"
    else
        FAILED_TASKS+=("$task_name")
        error "✗ $task_name failed"
    fi
    echo
}

show_summary() {
    echo
    info "=============== UPDATE SUMMARY ==============="

    if [[ ${#COMPLETED_TASKS[@]} -gt 0 ]]; then
        success "Completed tasks:"
        printf '  ✓ %s\n' "${COMPLETED_TASKS[@]}"
    fi

    if [[ ${#FAILED_TASKS[@]} -gt 0 ]]; then
        error "Failed tasks:"
        printf '  ✗ %s\n' "${FAILED_TASKS[@]}"
    fi

    info "=============================================="
}

create_backup() {
    local backup_dir="$HOME/.dotfiles_backup_$(date +%Y%m%d_%H%M%S)"

    if [[ "$DRY_RUN" == false ]]; then
        info "Creating backup at: $backup_dir"
        run_command "cp -r '$DOTFILES' '$backup_dir'"
        success "Backup created successfully"
    else
        info "[DRY RUN] Would create backup at: $backup_dir"
    fi
}

update_dotfiles() {
    info "Updating dotfiles..."

    run_command "cd '$DOTFILES' || exit"
    run_command "git pull origin main"
    run_command "./install --except shell"
    run_command "cd - >/dev/null 2>&1 || exit"

    info "Updating shell plugins with Sheldon..."
    run_command "sheldon lock --update"

    return 0
}

update_system() {
    info "Updating software installed with system package manager."
    package_manager="$(find_package_manager)"

    "${package_manager}"_update
    return 0
}

rpm_update() {
    run_command "sudo dnf upgrade --refresh -y"
}

arch_update() {
    if _exists pacman; then
        if _exists paru; then
            run_command "paru -Syu --noconfirm"
            return 0
        fi
        run_command "sudo pacman -Syu --noconfirm"
    fi
}

apt_update() {
    if _exists apt; then
        run_command "sudo apt update && sudo apt upgrade -y"
    elif _exists apt-get; then
        run_command "sudo apt-get update && sudo apt-get upgrade -y"
    fi
}

apt-wsl_update() {
    apt_update
}

snap_update() {
    if _exists snap; then
        info "Updating Snap packages..."
        run_command "sudo snap refresh"
        return 0
    fi
    return 1
}

flatpak_update() {
    if _exists flatpak; then
        info "Updating Flatpak packages..."
        run_command "flatpak update -y"
        return 0
    fi
    return 1
}

cargo_update() {
    info "Updating packages installed with Cargo."
    if _exists cargo-install-update; then
        run_command "cargo install-update -a"
        return 0
    else
        error "cargo-install-update not found. Install with: cargo install cargo-update"
        return 1
    fi
}

update_all_node() {
    if ! _exists fnm; then
        info "Fast Node Manager (fnm) not found. Unable to automatically update NodeJS."
        return 1
    fi

    info "Updating Node.js versions managed by fnm."
    echo

    # Get currently active version
    local current_version
    current_version=$(fnm current 2>/dev/null || echo "")

    # Update all installed versions
    if [[ "$DRY_RUN" == false ]]; then
        # Get list of installed versions
        local versions
        versions=$(fnm list | grep -v "system" | awk '{print $2}' | tr -d 'v')

        for version in $versions; do
            info "Updating Node.js v$version"
            # fnm doesn't have a direct "update" command, but we can reinstall
            run_command "fnm install $version --latest-npm"
        done

        # Install/update LTS if not already installed
        info "Ensuring LTS version is up to date."
        run_command "fnm install --lts --latest-npm"
    else
        info "[DRY RUN] Would update all installed Node.js versions"
        info "[DRY RUN] Would ensure LTS version is up to date"
    fi

    # Restore the originally active version if it changed
    if [[ -n "$current_version" ]] && [[ "$DRY_RUN" == false ]]; then
        info "Switching back to originally active version: $current_version"
        run_command "fnm use $current_version" || true
    fi

    return 0
}

npm_update() {
    if ! _exists npm; then
        info "npm not found. Skipping npm package updates."
        return 1
    fi

    # Ensure fnm environment is loaded if available
    if _exists fnm; then
        export PATH="$HOME/.local/share/fnm:$PATH"
        eval "$(fnm env --use-on-cd)" 2>/dev/null || true
    fi

    info "Updating software installed globally with NPM."
    run_command "npm update -g"
    return 0
}

uv_update() {
    if ! _exists uv; then
        return 1
    fi

    info "Updating Python packages managed by uv."

    # Update uv itself first using its self-update command
    info "Updating uv..."
    run_command "uv self update"

    # Update all uv-managed tools
    info "Upgrading all uv tool installations..."
    run_command "uv tool upgrade --all"

    return 0
}

update_rust() {
    if ! _exists rustup; then
        return 1
    fi

    info "Updating Rust..."
    echo

    run_command "rustup update"
    return 0
}

on_start() {
    info "     |-|                                             |-|     "
    info "     |-|           Custom update utility.            |-|     "
    info "     |-|                                             |-|     "
    info "     |-|      This script will attempt to update     |-|     "
    info "     |-|    the dotfiles repo and system packages.   |-|     "
    info "     |-|                                             |-|     "
    info "     |-|                                             |-|     "
    info "     |-|          created by @denysdovhan            |-|     "
    info "     |-|            forked by @BigMikeM              |-|     "
    info "     |-|                                             |-|     "

    if [[ "$DRY_RUN" == true ]]; then
        info "     |-|              DRY RUN MODE                |-|     "
    fi

    echo
}

main() {
    on_start

    # Create backup if requested
    if [[ "$CREATE_BACKUP" == true ]]; then
        track_task "Backup Creation" create_backup
    fi

    if [[ "$DRY_RUN" == false ]]; then
        echo "Please enter your password to get started:"
        sudo -v

        # Keep sudo alive
        while true; do
            sudo -n true
            sleep 60
            kill -0 "$$" || exit
        done 2>/dev/null &
    fi

    track_task "Dotfiles Update" update_dotfiles

    if [[ "$SKIP_SYSTEM" == false ]]; then
        track_task "System Update" update_system
        track_task "Flatpak Update" flatpak_update
        track_task "Snap Update" snap_update
    fi

    if [[ "$SKIP_RUST" == false ]]; then
        track_task "Rust Update" update_rust
        track_task "Cargo Update" cargo_update
    fi

    if [[ "$SKIP_NODE" == false ]]; then
        track_task "Node.js Update" update_all_node
        track_task "NPM Update" npm_update
    fi

    # Update Python packages managed by uv
    track_task "UV Python Update" uv_update

    show_summary
    on_finish
}

main
